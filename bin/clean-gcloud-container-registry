#!/bin/zsh

if (( $# == 0 )); then
    exit 1
fi

delete_tags() {
    local image
    image=$1
    shift
    local -a items
    for tag in $@; do
        items+=$image@$tag
    done
    if [[ ${#items} > 0 ]]; then
        gcloud container images delete --quiet --force-delete-tags $items
    fi
}

# set -x
REPO=$1
IMAGES=("${(@f)$(gcloud container images list --repository $REPO --limit=unlimited --format='get(name)')}")
for image in $IMAGES; do
    # delete untagged
    TAGS=("${(@f)$(gcloud container images list-tags $image --filter='-tags:*' --format='get(digest)' --limit=unlimited)}")
    delete_tags $image $TAGS
    # delete all build-* tags except last 3
    TAGS=("${(@f)$(gcloud container images list-tags $image --filter='tags:build-*' --format='get(digest)' --limit=unlimited)}")
    delete_tags $image ${TAGS[@]:3}
done

# print after
# gsutil du -hs $BUCKET

